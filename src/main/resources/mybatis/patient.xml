<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.sportsdata.webapp.youth.dao.hospital.PatientDAO">
	<!-- 查询挂号记录 -->
    <select id="getRegisteRecordList" resultType="cn.sportsdata.webapp.youth.common.vo.patient.PatientRegistRecord" parameterType="java.util.Map">
    	select A.* from patient_regist A
	       	where A.doctor=#{doctor_code} and A.hospital_id=#{hospital_id} 
	       	and A.status = 'active' and year(VISIT_DATE) = #{year} 
	       	and month(VISIT_DATE) =#{month} and day(VISIT_DATE) = #{day}
	       	order by VISIT_DATE desc, VISIT_NO
    </select>
    
    <!-- 查询门诊记录 -->
    <select id="getMedicalRecordList" resultType="cn.sportsdata.webapp.youth.common.vo.patient.MedicalRecordVO" parameterType="java.util.Map">
    	select A.* from medical_record A
	       	where A.DOCTOR_NO=#{doctor_code} and A.hospital_id=#{hospital_id} 
	       	and A.status = 'active' and year(VISIT_DATE) = #{year} 
	       	and month(VISIT_DATE) =#{month} and day(VISIT_DATE) = #{day}
	       	order by VISIT_DATE desc, VISIT_NO
    </select>
    
    <!-- 查询手术记录 -->
    <select id="getCurMyOperationRecordList" resultType="cn.sportsdata.webapp.youth.common.vo.patient.OpertaionRecord" parameterType="java.util.Map">
        select A.* from operation A
        	left join resident_record B on B.patient_id = A.patient_id
	       	where A.doctor_id=#{doctor_code} and A.hospital_id=#{hospital_id} 
	       	and A.status = 'active' and B.IN_OUT_STATUS = 0 order by OPERATING_DATE desc
    </select>
    
    <select id="getMyOperationRecordList" resultType="cn.sportsdata.webapp.youth.common.vo.patient.OpertaionRecord" parameterType="java.util.Map">
        select A.* from operation A
	       	where A.doctor_id=#{doctor_code} and A.hospital_id=#{hospital_id} 
	       	and A.status = 'active' order by OPERATING_DATE desc
    </select>
    
    <select id="getFirstAsistOperationRecordList" resultType="cn.sportsdata.webapp.youth.common.vo.patient.OpertaionRecord" parameterType="java.util.Map">
        select A.* from operation A
	       	where A.FIRST_ASSISTANT=#{doctor_name} and A.hospital_id=#{hospital_id} 
	       	and A.status = 'active' order by OPERATING_DATE desc
    </select>
    
    <select id="getSecondAsistOperationRecordList" resultType="cn.sportsdata.webapp.youth.common.vo.patient.OpertaionRecord" parameterType="java.util.Map">
        select A.* from operation A
	       	where A.SECOND_ASSISTANT=#{doctor_name} and A.hospital_id=#{hospital_id} 
	       	and A.status = 'active' order by OPERATING_DATE desc
    </select>
    
    <select id="getAnesthesiaOperationRecordList" resultType="cn.sportsdata.webapp.youth.common.vo.patient.OpertaionRecord" parameterType="java.util.Map">
        select A.* from operation A
	       	where A.ANESTHESIA_DOCTOR=#{doctor_name} and A.hospital_id=#{hospital_id} 
	       	and A.status = 'active' order by OPERATING_DATE desc
    </select>
    
    <!-- 查询住院记录 -->
    <select id="getCurPatientsInHospital" resultType="cn.sportsdata.webapp.youth.common.vo.patient.PatientInHospital" parameterType="java.util.Map">
        select A.* from patient_in_hospital A
	       	where A.doctor_id=#{doctor_code} and A.hospital_id=#{hospital_id} 
	       	and A.status = 'active' order by ADMISSION_DATE_TIME desc
    </select>
    
    <!-- 查询出院记录 -->
    <select id="getCurMyResidentRecordList" resultType="cn.sportsdata.webapp.youth.common.vo.patient.ResidentRecord" parameterType="java.util.Map">
        select A.* from resident_record A
	       	where A.doctor_id=#{doctor_code} and A.hospital_id=#{hospital_id} 
	       	and A.status = 'active' and A.IN_OUT_STATUS = 0 order by ADMISSION_DATE desc
    </select>
    
    <select id="getMyResidentRecordList" resultType="cn.sportsdata.webapp.youth.common.vo.patient.ResidentRecord" parameterType="java.util.Map">
        select A.* from resident_record A
	       	where A.doctor_id=#{doctor_code} and A.hospital_id=#{hospital_id} 
	       	and year(ADMISSION_DATE) = #{year} and month(ADMISSION_DATE) =#{month}
	       	and A.status = 'active' and A.IN_OUT_STATUS = 1 order by ADMISSION_DATE desc
    </select>
    
    <select id="getDirectResidentRecordList" resultType="cn.sportsdata.webapp.youth.common.vo.patient.ResidentRecord" parameterType="java.util.Map">
        select A.* from resident_record A
	       	where A.DIRECTOR=#{doctor_name} and A.hospital_id=#{hospital_id} 
	       	and year(ADMISSION_DATE) = #{year} and month(ADMISSION_DATE) =#{month}
	       	and A.status = 'active' and A.IN_OUT_STATUS = 1 order by ADMISSION_DATE desc
    </select>
    
    <select id="getAttendingResidentRecordList" resultType="cn.sportsdata.webapp.youth.common.vo.patient.ResidentRecord" parameterType="java.util.Map">
        select A.* from resident_record A
	       	where A.ATTENDING_DOCTOR=#{doctor_name} and A.hospital_id=#{hospital_id} 
	       	and year(ADMISSION_DATE) = #{year} and month(ADMISSION_DATE) =#{month}
	       	and A.status = 'active' and A.IN_OUT_STATUS = 1 order by ADMISSION_DATE desc
    </select>
    
    <!-- 查询单个病人所有记录 -->
   	<select id="getOperationById" resultType="cn.sportsdata.webapp.youth.common.vo.patient.OpertaionRecord" parameterType="java.util.Map">
    	select A.* from operation A where A.id = #{id}
    </select>
    
   	<select id="getResidentById" resultType="cn.sportsdata.webapp.youth.common.vo.patient.ResidentRecord" parameterType="java.util.Map">
    	select A.* from resident_record A where A.id = #{id}
    </select>
    
    <select id="getMedicalRecordById" resultType="cn.sportsdata.webapp.youth.common.vo.patient.MedicalRecordVO" parameterType="java.util.Map">
    	select A.* from medical_record A where A.id = #{id}
    </select>
    
    <select id="getResidentRecordByOperation" resultType="cn.sportsdata.webapp.youth.common.vo.patient.ResidentRecord" parameterType="java.util.Map">
    	select A.* from resident_record A 
	       	where A.patient_id=#{patient_id} and A.hospital_id=#{hospital_id} and A.status = 'active' 
	       	and #{operating_date} &gt; A.ADMISSION_DATE 
	       	and (#{operating_date} &lt; A.discharge_date_time or A.discharge_date_time is null)
	       	order by ADMISSION_DATE desc
    </select>
    
    <select id="getOperationsByResident" resultType="cn.sportsdata.webapp.youth.common.vo.patient.OpertaionRecord" parameterType="java.util.Map">
    	select A.* from operation A 
	       	where A.patient_id=#{patient_id} and A.hospital_id=#{hospital_id} and A.status = 'active' 
	       	and OPERATING_DATE &gt; #{admission_date} 
	       	and OPERATING_DATE &lt; #{discharge_date}
	       	order by OPERATING_DATE desc
    </select>
    
    <select id="getPatientOperationRecords" resultType="cn.sportsdata.webapp.youth.common.vo.patient.OpertaionRecord" parameterType="java.util.Map">
    	select A.* from operation A 
	       	where A.patient_id in (select patient_number FROM patient where real_name = #{patient_name})
	       	and A.hospital_id=#{hospital_id} 
	       	and A.status = 'active' and A.id != #{record_id} order by OPERATING_DATE desc
    </select>
    
    <select id="getPatientResidentRecords" resultType="cn.sportsdata.webapp.youth.common.vo.patient.ResidentRecord" parameterType="java.util.Map">
        select A.* from resident_record A
	       	where A.patient_id in (SELECT patient_number FROM patient where real_name = #{patient_name})
	       	and A.hospital_id=#{hospital_id} 
	       	and A.status = 'active' and A.id != #{record_id} order by ADMISSION_DATE desc
    </select>
    
    <select id="getPatientMedicalRecords" resultType="cn.sportsdata.webapp.youth.common.vo.patient.MedicalRecordVO" parameterType="java.util.Map">
    	select A.* from medical_record A
	       	where  A.patient_id in (SELECT patient_number FROM patient where real_name = #{patient_name})
        	and A.patient_id=#{patient_id}
	       	and A.status = 'active' and A.id != #{record_id} order by VISIT_DATE desc, VISIT_NO
    </select>
    
    <!-- 医生查询自己的病人，按名字查询病人信息 -->
    <select id="searchPatientMedicalRecord" resultType="cn.sportsdata.webapp.youth.common.vo.patient.MedicalRecordVO" parameterType="java.util.Map">
    	select A.* from medical_record A left join patient B on B.patient_number = A.PATIENT_ID
	       	where A.DOCTOR_NO=#{doctor_code} and A.hospital_id=#{hospital_id} 
	       	and A.status = 'active' and B.real_name like CONCAT('%', #{patient_name},'%')
	       	order by VISIT_DATE desc, VISIT_NO
    </select>
    
    <select id="searchPatientOperationRecord" resultType="cn.sportsdata.webapp.youth.common.vo.patient.OpertaionRecord" parameterType="java.util.Map">
        select A.* from operation A left join patient B on B.patient_number = A.PATIENT_ID 
	       	where A.hospital_id=#{hospital_id} and B.real_name like CONCAT('%', #{patient_name},'%')
	       	and A.status = 'active' order by OPERATING_DATE desc
    </select>
    
    <select id="searchPatientResidentRecord" resultType="cn.sportsdata.webapp.youth.common.vo.patient.MedicalRecordVO" parameterType="java.util.Map">
        select A.* from resident_record A
	       	where A.hospital_id=#{hospital_id} and A.NAME = #{patient_name}
	       	and A.status = 'active' order by ADMISSION_DATE desc
    </select>


    <select id="getRecordAssetList" resultType="cn.sportsdata.webapp.youth.common.vo.patient.RecordAssetVO" parameterType="java.util.Map">
		select A.id as id, A.record_asset_type_id as asset_type_id, B.id as asset_id, 
		C.name as asset_type_name, A.created_time from hospital_record_asset A 
		join asset B on B.id = A.asset_id 
		join record_asset_type C on C.id = A.record_asset_type_id
		where A.hospital_record_id=#{record_id} and A.status = 'active' order by A.created_time desc
    </select>
    
    <select id="getRecordAssetTypeList" resultType="cn.sportsdata.webapp.youth.common.vo.patient.RecordAssetTypeVO" parameterType="java.util.Map">
		select A.id, A.name, A.record_type as recordType from record_asset_type A 
		where A.record_type=#{record_type} and A.status = 'active' order by A.id asc
    </select>
    
    <insert id="insertRecordAsset" parameterType="java.util.Map">
		insert into hospital_record_asset (id, hospital_id, hospital_record_id, asset_id, medical_data_type_id) 
		values(uuid(),  #{hospital_id},  #{hospital_record_id},  #{asset_id},  #{medical_data_type_id})
    </insert>
    
    <select id="getDoctorInfoByUsername" resultType="cn.sportsdata.webapp.youth.common.vo.patient.DoctorVO" parameterType="java.util.Map">
		select A.* from doctor A 
		left join user B on B.id = A.login_user_id
		where B.user_name=#{username} and A.status = 'active' order by A.id asc
    </select>
    
 	<select id="getPatients" parameterType="java.util.List" resultType="cn.sportsdata.webapp.youth.common.vo.patient.PatientInfoVO">
        select * from patient where patient_number in
        <foreach collection="patientIdList" item="id" index="index"
            open="(" close=")" separator=",">
            #{id}
        </foreach>
    </select>
    
    <update id="updateMedicalRecord" parameterType="cn.sportsdata.webapp.youth.common.vo.patient.MedicalRecordVO">
    	update medical_record set  
    	yb_icd_name = #{medicalRecordVO.ybIcdName},
		visit_no = #{medicalRecordVO.visitNo},
		visit_date = #{medicalRecordVO.visitDate},
		patient_id = #{medicalRecordVO.patientId},
		treatment = #{medicalRecordVO.treatment},
		tooth = #{medicalRecordVO.tooth},
		suggestion = #{medicalRecordVO.suggestion},
		status = #{medicalRecordVO.status},
<!-- 		physician_secondary_number = #{medicalRecordVO.physicianSecondaryNumber}, -->
<!-- 		physician_primary_number = #{medicalRecordVO.physicianPrimaryNumber}, -->
<!-- 		physician_name = #{medicalRecordVO.physicianName}, -->
<!-- 		physician_email = #{medicalRecordVO.physicianEmail}, -->
		ordinal = #{medicalRecordVO.ordinal},
		operation_record = #{medicalRecordVO.operationRecord},
		menses4 = #{medicalRecordVO.menses4},
		menses3 = #{medicalRecordVO.menses3},
		menses2 = #{medicalRecordVO.menses2},
		menses = #{medicalRecordVO.menses},
		memo = #{medicalRecordVO.memo},
		medical_record = #{medicalRecordVO.medicalRecord},
<!-- 		medical_condition = #{medicalRecordVO.medicalCondition}, -->
		med_history = #{medicalRecordVO.medHistory},
		maternity = #{medicalRecordVO.maternity},
		marrital = #{medicalRecordVO.marrital},
<!-- 		insurance_provider_number = #{medicalRecordVO.insuranceProviderNumber}, -->
<!-- 		insurance_provider_name = #{medicalRecordVO.insuranceProviderName}, -->
<!-- 		insurance_policy_number = #{medicalRecordVO.insurancePolicyNumber}, -->
<!-- 		insurance_policy_holder = #{medicalRecordVO.insurancePolicyHolder}, -->
		individual = #{medicalRecordVO.individual},
		illness_desc = #{medicalRecordVO.illnessDesc},
		illness_date = #{medicalRecordVO.illnessDate},
		hospital_id = #{medicalRecordVO.hospitalId},
		family_ill = #{medicalRecordVO.familyIll},
		doctor_no = #{medicalRecordVO.doctorNo},
		doctor = #{medicalRecordVO.doctor},
		diag_yb_db = #{medicalRecordVO.diagYbDb},
		diag_desc = #{medicalRecordVO.diagDesc},
		cfz_flag = #{medicalRecordVO.cfzFlag},
		cdiag = #{medicalRecordVO.cdiag},
		body_exam = #{medicalRecordVO.bodyExam},
		assistant_exam = #{medicalRecordVO.assistantExam},
		anamnesis = #{medicalRecordVO.anamnesis},
<!-- 		allergies = #{medicalRecordVO.allergies}, -->
		advice = #{medicalRecordVO.advice}
    	where id = #{medicalRecordVO.id}
    </update>
    
     <update id="updateOperationRecord" parameterType="cn.sportsdata.webapp.youth.common.vo.patient.OpertaionRecord">
     	update operation set  
     	wound_grade = #{opertaionRecord.woundGrade},
		visit_id = #{opertaionRecord.visitId},
		status = #{opertaionRecord.status},
		second_assistant = #{opertaionRecord.secondAssistant},
		patient_id = #{opertaionRecord.patientId},
		optype_primary = #{opertaionRecord.optypePrimary},
		operator = #{opertaionRecord.operator},
		operation_stop_date = #{opertaionRecord.operationStopDate},
		operation_start_date = #{opertaionRecord.operationStartDate},
		operation_scale = #{opertaionRecord.operationScale},
		operation_nurse = #{opertaionRecord.operationNurse},
		operation_no = #{opertaionRecord.operationNo},
		operation_emer_indicator = #{opertaionRecord.operationEmerIndicator},
		operation_desc = #{opertaionRecord.operationDescription},
		operation_code = #{opertaionRecord.operationCode},
		operating_end_date = #{opertaionRecord.operatingEndDate},
		operating_date = #{opertaionRecord.operatingDate},
		op_primary = #{opertaionRecord.opPrimary},
		if_gck = #{opertaionRecord.ifGck},
		hospital_id = #{opertaionRecord.hospitalId},
		heal = #{opertaionRecord.heal},
		first_assistant = #{opertaionRecord.firstAssistant},
		doctor_id = #{opertaionRecord.doctorId},
		before_oper = #{opertaionRecord.beforeOper},
		anesthesia_doctor = #{opertaionRecord.anesthesiaDoctor},
		anaesthesia_method = #{opertaionRecord.anaesthesiaMethod},
		before_diagnosis = #{opertaionRecord.beforeDiagnosis},
		after_diagnosis = #{opertaionRecord.afterDiagnosis},
		operationDesc = #{opertaionRecord.operationDesc},
		process = #{opertaionRecord.process},
		posture = #{opertaionRecord.posture},
		incision = #{opertaionRecord.incision},
		exploratory = #{opertaionRecord.exploratory},
		steps = #{opertaionRecord.steps},
		drainage = #{opertaionRecord.drainage},
		finished_condition = #{opertaionRecord.finishedCondition}
     	where id = #{opertaionRecord.id}
     	
     </update>
     
     <update id="updateResidentRecord" parameterType="cn.sportsdata.webapp.youth.common.vo.patient.ResidentRecord">
     	update resident_record set  
		hospital_id = #{residentRecord.hospitalId},
		patient_id = #{residentRecord.patientId},
		doctor_id = #{residentRecord.doctorId},
		create_time = #{residentRecord.createTime},
		last_update = #{residentRecord.lastUpdate},
		status = #{residentRecord.status},
		start_time = #{residentRecord.startTime},
		end_time = #{residentRecord.endTime},
		department_id = #{residentRecord.departmentId},
		name = #{residentRecord.name},
		admission_number = #{residentRecord.admissionNumber},
		gender = #{residentRecord.gender},
		age = #{residentRecord.age},
		fee_type = #{residentRecord.feeType},
		patients_section_code = #{residentRecord.patientsSectionCode},
		discharge_date_time = #{residentRecord.dischargeDateTime},
		in_out_status = #{residentRecord.inOutStatus},
		hospital_beds = #{residentRecord.hospitalBeds},
		admission_date = #{residentRecord.admissionDate},
		section_date = #{residentRecord.sectionDate},
		diagnose = #{residentRecord.diagnose},
		nurse_level = #{residentRecord.nurseLevel},
		critical_level = #{residentRecord.criticalLevel},
		doctor_in_charge = #{residentRecord.doctorInCharge},
		resident_id = #{residentRecord.residentId},
		director = #{residentRecord.director},
		attending_doctor = #{residentRecord.attendingDoctor},
		update_date = #{residentRecord.updateDate},
		in_state = #{residentRecord.inState},
		in_chi_diagnosis = #{residentRecord.inChiDiagnosis},
		in_wes_diagnosis = #{residentRecord.inWesDiagnosis},
		process = #{residentRecord.process},
		out_chi_diagnosis = #{residentRecord.outChiDiagnosis},
		out_wes_diagnosis = #{residentRecord.outWesDiagnosis},
		out_state = #{residentRecord.outState},
		suggestion = #{residentRecord.suggestion}
     	where id = #{residentRecord.id}
     	
     </update>
    
</mapper>

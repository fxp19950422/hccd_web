<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.sportsdata.webapp.youth.dao.hospital.PatientDAO">
	<!-- 查询挂号记录 -->
    <select id="getRegisteRecordList" resultType="cn.sportsdata.webapp.youth.common.vo.patient.PatientRegistRecord" parameterType="java.util.Map">
    	select A.* from patient_regist A
	       	where A.doctor=#{doctor_code} and A.hospital_id=#{hospital_id} 
	       	and A.status = 'active' and year(VISIT_DATE) = #{year} 
	       	and month(VISIT_DATE) =#{month} and day(VISIT_DATE) = #{day}
	       	order by VISIT_DATE desc, VISIT_NO
    </select>
    
    <!-- 查询门诊记录 -->
    <select id="getMedicalRecordList" resultType="cn.sportsdata.webapp.youth.common.vo.patient.MedicalRecordVO" parameterType="java.util.Map">
    	select A.* from medical_record A
	       	where A.DOCTOR_NO=#{doctor_code} and A.hospital_id=#{hospital_id} 
	       	and A.status = 'active' and year(VISIT_DATE) = #{year} 
	       	and month(VISIT_DATE) =#{month} and day(VISIT_DATE) = #{day}
	       	order by VISIT_DATE desc, VISIT_NO
    </select>
    
      <!-- 查询门诊记录 -->
    <select id="getHospitalMedicalRecordList" resultType="cn.sportsdata.webapp.youth.common.vo.patient.MedicalRecordVO" parameterType="java.util.Map">
    	select A.*, B.real_name, B.identity_card from patient B, medical_record A 
   		<if test="depart_code != null and depart_code != '' ">
	   		inner join doctor C on (A.doctor_no = C.user_id)
	    	inner join (SELECT A.* FROM medical.department A left outer join department B on A.parent_department_id = B.department_code
				where A.department_code = #{depart_code}
				union 
			SELECT B.* FROM medical.department A left outer join department B on B.parent_department_id = A.department_code where A.department_code = #{depart_code}
				) D   on (C.department_id = D.department_code)
   		</if>
	       	where 
            A.patient_id = B.patient_number 
            and A.status = 'active'
	       	<if test="doctor_code != null and doctor_code != '' ">
    			and A.DOCTOR_NO=#{doctor_code}
    		</if>
    		<if test="name != null and name != '' ">
    			and A.name like '${name}%'
    		</if>
    		<!-- <if test="idNumber != null and idNumber != '' ">
    			and A.id like '${idNumber}%'
    		</if> -->
	       	order by VISIT_DATE desc, VISIT_NO
    </select>
    
    <!-- 查询手术记录 -->
    <select id="getCurMyOperationRecordList" resultType="cn.sportsdata.webapp.youth.common.vo.patient.OpertaionRecord" parameterType="java.util.Map">
        select A.* from operation A
        	left join resident_record B on B.patient_id = A.patient_id
	       	where A.doctor_id=#{doctor_code} and A.hospital_id=#{hospital_id} 
	       	and A.status = 'active' and B.IN_OUT_STATUS = 0 order by OPERATING_DATE desc
    </select>
    
    <select id="getMyOperationRecordList" resultType="cn.sportsdata.webapp.youth.common.vo.patient.OpertaionRecord" parameterType="java.util.Map">
        select A.* from operation A
	       	where A.doctor_id=#{doctor_code} and A.hospital_id=#{hospital_id} 
	       	and A.status = 'active' order by OPERATING_DATE desc
    </select>
    
    <select id="getFirstAsistOperationRecordList" resultType="cn.sportsdata.webapp.youth.common.vo.patient.OpertaionRecord" parameterType="java.util.Map">
        select A.* from operation A
	       	where A.FIRST_ASSISTANT=#{doctor_name} and A.hospital_id=#{hospital_id} 
	       	and A.status = 'active' order by OPERATING_DATE desc
    </select>
    
    <select id="getSecondAsistOperationRecordList" resultType="cn.sportsdata.webapp.youth.common.vo.patient.OpertaionRecord" parameterType="java.util.Map">
        select A.* from operation A
	       	where A.SECOND_ASSISTANT=#{doctor_name} and A.hospital_id=#{hospital_id} 
	       	and A.status = 'active' order by OPERATING_DATE desc
    </select>
    
    <select id="getAnesthesiaOperationRecordList" resultType="cn.sportsdata.webapp.youth.common.vo.patient.OpertaionRecord" parameterType="java.util.Map">
        select A.* from operation A
	       	where A.ANESTHESIA_DOCTOR=#{doctor_name} and A.hospital_id=#{hospital_id} 
	       	and A.status = 'active' order by OPERATING_DATE desc
    </select>
    
    <!-- 查询住院记录 -->
    <select id="getCurPatientsInHospital" resultType="cn.sportsdata.webapp.youth.common.vo.patient.PatientInHospital" parameterType="java.util.Map">
        select A.* from patient_in_hospital A
	       	where A.doctor_id=#{doctor_code} and A.hospital_id=#{hospital_id} 
	       	and A.status = 'active' order by ADMISSION_DATE_TIME desc
    </select>
    
    <!-- 查询出院记录 -->
    <select id="getCurMyResidentRecordList" resultType="cn.sportsdata.webapp.youth.common.vo.patient.ResidentRecord" parameterType="java.util.Map">
        select A.* from resident_record A
	       	where A.doctor_id=#{doctor_code} and A.hospital_id=#{hospital_id} 
	       	and A.status = 'active' and A.IN_OUT_STATUS = 0 order by ADMISSION_DATE desc
    </select>
    
    <select id="getMyResidentRecordList" resultType="cn.sportsdata.webapp.youth.common.vo.patient.ResidentRecord" parameterType="java.util.Map">
        select A.* from resident_record A
	       	where A.doctor_id=#{doctor_code} and A.hospital_id=#{hospital_id} 
	       	and year(ADMISSION_DATE) = #{year} and month(ADMISSION_DATE) =#{month}
	       	and A.status = 'active' and A.IN_OUT_STATUS = 1 order by ADMISSION_DATE desc
    </select>
    
    <select id="getDirectResidentRecordList" resultType="cn.sportsdata.webapp.youth.common.vo.patient.ResidentRecord" parameterType="java.util.Map">
        select A.* from resident_record A
	       	where A.DIRECTOR=#{doctor_name} and A.hospital_id=#{hospital_id} 
	       	and year(ADMISSION_DATE) = #{year} and month(ADMISSION_DATE) =#{month}
	       	and A.status = 'active' and A.IN_OUT_STATUS = 1 order by ADMISSION_DATE desc
    </select>
    
    <select id="getAttendingResidentRecordList" resultType="cn.sportsdata.webapp.youth.common.vo.patient.ResidentRecord" parameterType="java.util.Map">
        select A.* from resident_record A
	       	where A.ATTENDING_DOCTOR=#{doctor_name} and A.hospital_id=#{hospital_id} 
	       	and year(ADMISSION_DATE) = #{year} and month(ADMISSION_DATE) =#{month}
	       	and A.status = 'active' and A.IN_OUT_STATUS = 1 order by ADMISSION_DATE desc
    </select>
    
    <!-- 查询单个病人所有记录 -->
   	<select id="getOperationById" resultType="cn.sportsdata.webapp.youth.common.vo.patient.OpertaionRecord" parameterType="java.util.Map">
    	select A.* from operation A where A.id = #{id}
    </select>
    
   	<select id="getResidentById" resultType="cn.sportsdata.webapp.youth.common.vo.patient.ResidentRecord" parameterType="java.util.Map">
    	select A.* from resident_record A where A.id = #{id}
    </select>
    
    <select id="getResidentRecordByOperation" resultType="cn.sportsdata.webapp.youth.common.vo.patient.ResidentRecord" parameterType="java.util.Map">
    	select A.* from resident_record A 
	       	where A.patient_id=#{patient_id} and A.hospital_id=#{hospital_id} and A.status = 'active' 
	       	and #{operating_date} &gt; A.ADMISSION_DATE 
	       	and (#{operating_date} &lt; A.discharge_date_time or A.discharge_date_time is null)
	       	order by ADMISSION_DATE desc
    </select>
    
    <select id="getOperationsByResident" resultType="cn.sportsdata.webapp.youth.common.vo.patient.OpertaionRecord" parameterType="java.util.Map">
    	select A.* from operation A 
	       	where A.patient_id=#{patient_id} and A.hospital_id=#{hospital_id} and A.status = 'active' 
	       	and OPERATING_DATE &gt; #{admission_date} 
	       	and OPERATING_DATE &lt; #{discharge_date}
	       	order by OPERATING_DATE desc
    </select>
    
    <select id="getPatientOperationRecords" resultType="cn.sportsdata.webapp.youth.common.vo.patient.OpertaionRecord" parameterType="java.util.Map">
    	select A.* from operation A 
	       	where A.patient_id in (select patient_number FROM patient where real_name = #{patient_name})
	       	and A.hospital_id=#{hospital_id} 
	       	and A.status = 'active' and A.id != #{record_id} order by OPERATING_DATE desc
    </select>
    
    <select id="getPatientResidentRecords" resultType="cn.sportsdata.webapp.youth.common.vo.patient.ResidentRecord" parameterType="java.util.Map">
        select A.* from resident_record A
	       	where A.patient_id in (SELECT patient_number FROM patient where real_name = #{patient_name})
	       	and A.hospital_id=#{hospital_id} 
	       	and A.status = 'active' and A.id != #{record_id} order by ADMISSION_DATE desc
    </select>
    
    <select id="getPatientMedicalRecords" resultType="cn.sportsdata.webapp.youth.common.vo.patient.MedicalRecordVO" parameterType="java.util.Map">
    	select A.* from medical_record A
	       	where  A.patient_id in (SELECT patient_number FROM patient where real_name = #{patient_name})
        	and A.patient_id=#{patient_id}
	       	and A.status = 'active' and A.id != #{record_id} order by VISIT_DATE desc, VISIT_NO
    </select>
    
    <select id="getMedicalRecordByID" resultType="cn.sportsdata.webapp.youth.common.vo.patient.MedicalRecordVO" parameterType="java.util.Map">
    	SELECT * FROM medical.medical_record A, patient B, doctor C where A.patient_id = B.patient_number
 		and A.doctor_no = C.user_id and A.id = #{record_id}
    </select>
    
    <!-- 医生查询自己的病人，按名字查询病人信息 -->
    <select id="searchPatientMedicalRecord" resultType="cn.sportsdata.webapp.youth.common.vo.patient.MedicalRecordVO" parameterType="java.util.Map">
    	select A.* from medical_record A left join patient B on B.patient_number = A.PATIENT_ID
	       	where A.DOCTOR_NO=#{doctor_code} and A.hospital_id=#{hospital_id} 
	       	and A.status = 'active' and B.real_name like CONCAT('%', #{patient_name},'%')
	       	order by VISIT_DATE desc, VISIT_NO
    </select>
    
    <select id="searchPatientOperationRecord" resultType="cn.sportsdata.webapp.youth.common.vo.patient.OpertaionRecord" parameterType="java.util.Map">
        select A.* from operation A left join patient B on B.patient_number = A.PATIENT_ID 
	       	where A.hospital_id=#{hospital_id} and B.real_name like CONCAT('%', #{patient_name},'%')
	       	and A.status = 'active' order by OPERATING_DATE desc
    </select>
    
    <select id="searchPatientResidentRecord" resultType="cn.sportsdata.webapp.youth.common.vo.patient.MedicalRecordVO" parameterType="java.util.Map">
        select A.* from resident_record A
	       	where A.hospital_id=#{hospital_id} and A.NAME = #{patient_name}
	       	and A.status = 'active' order by ADMISSION_DATE desc
    </select>


    <select id="getRecordAssetList" resultType="cn.sportsdata.webapp.youth.common.vo.patient.RecordAssetVO" parameterType="java.util.Map">
		select A.id as id, A.record_asset_type_id as asset_type_id, B.id as asset_id, 
		C.name as asset_type_name, A.created_time from hospital_record_asset A 
		join asset B on B.id = A.asset_id 
		join record_asset_type C on C.id = A.record_asset_type_id
		where A.hospital_record_id=#{record_id} and A.status = 'active' order by A.created_time desc
    </select>
    
    <select id="getRecordAssetTypeList" resultType="cn.sportsdata.webapp.youth.common.vo.patient.RecordAssetTypeVO" parameterType="java.util.Map">
		select A.id, A.name, A.record_type as recordType from record_asset_type A 
		where A.record_type=#{record_type} and A.status = 'active' order by A.id asc
    </select>
    
    <insert id="insertRecordAsset" parameterType="java.util.Map">
		insert into hospital_record_asset (id, hospital_id, hospital_record_id, asset_id, medical_data_type_id) 
		values(uuid(),  #{hospital_id},  #{hospital_record_id},  #{asset_id},  #{medical_data_type_id})
    </insert>
    
     <insert id="updateMedicalRecordById" parameterType="java.util.Map">
		update medical_record set illness_desc=#{illness_desc}, med_history=#{med_history},body_exam=#{body_exam},diag_desc=#{diag_desc},treatment=#{treatment},
		suggestion=#{suggestion} where id=#{record_id}
    </insert>
    
    <select id="getDoctorInfoByUsername" resultType="cn.sportsdata.webapp.youth.common.vo.patient.DoctorVO" parameterType="java.util.Map">
		select A.* from doctor A 
		left join user B on B.id = A.login_user_id
		where B.user_name=#{username} and A.status = 'active' order by A.id asc
    </select>
    
 	<select id="getPatients" parameterType="java.util.List" resultType="cn.sportsdata.webapp.youth.common.vo.patient.PatientInfoVO">
        select * from patient where patient_number in
        <foreach collection="patientIdList" item="id" index="index"
            open="(" close=")" separator=",">
            #{id}
        </foreach>
    </select>
</mapper>
